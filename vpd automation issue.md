# VPD Automation Issue & Intelligent Environment Control Strategy

**Date:** 2026-01-19  
**Status:** ðŸ”´ Critical - VPD/Humidity Not Reaching Targets  
**Current VPD:** 2.09 kPa (Target: 0.4-0.8 kPa for Seedling)  
**Current Humidity:** ~46% (Target: 65-75% for Seedling)

---

## Problem Statement

### Current Situation
- âœ… **Temperature:** On target (80Â°F day / 70Â°F night)
- âœ… **Light Schedule:** Correct (20/4 photoperiod)
- âŒ **VPD:** 2.09 kPa (Target: 0.4-0.8 kPa) - **TOO HIGH**
- âŒ **Humidity:** ~46% (Target: 65-75%) - **TOO LOW**

### Root Cause Analysis

**Why VPD is too high:**
1. **Baseline Environment:** Basement humidity is ~30% (very dry)
2. **Exhaust Fan:** Running at power level 5, removing moisture faster than humidifier can add it
3. **Humidifier:** CloudForge T5 is running but can't keep up with air exchange rate
4. **System Imbalance:** Exhaust fan and humidifier are working against each other

**The Physics:**
- VPD = Vapor Pressure Deficit (measure of "dryness")
- High VPD = Dry air = Plants lose water too fast
- Low VPD = Humid air = Plants can't transpire properly
- **Exhaust fan removes moisture** â†’ Increases VPD
- **Humidifier adds moisture** â†’ Decreases VPD
- **Current:** Exhaust (power 5) > Humidifier capacity â†’ VPD stays high

---

## Solution: Intelligent Coordinated Control System

### Strategy Overview

Instead of controlling devices independently, we need **coordinated automations** that work together:

1. **When VPD is TOO HIGH (>0.8 kPa):**
   - âœ… Turn ON humidifier (already implemented)
   - âœ… **Reduce exhaust fan power** (5 â†’ 2) to retain moisture
   - âœ… Maintain heater at target temp

2. **When VPD is TOO LOW (<0.4 kPa):**
   - âœ… Turn OFF humidifier (already implemented)
   - âœ… **Increase exhaust fan power** (2 â†’ 5) to remove excess moisture
   - âœ… Maintain heater at target temp

3. **When VPD is OPTIMAL (0.4-0.8 kPa):**
   - âœ… Keep humidifier OFF (unless it drops below 0.4)
   - âœ… Keep exhaust fan at normal power (5)
   - âœ… Maintain heater at target temp

### The Key Insight

**Exhaust fan power is a control variable, not just a fixed setting.**

By dynamically adjusting exhaust fan speed based on VPD, we create a **feedback loop**:
- High VPD â†’ Lower fan â†’ Less moisture removal â†’ VPD decreases
- Low VPD â†’ Higher fan â†’ More moisture removal â†’ VPD increases

This works **in conjunction** with the humidifier to create a balanced system.

---

## Implementation Plan

### Phase 1: Add Fan Power Control to Automation Manager

**File:** `dashboard/src/services/automation-manager.js`

**Changes Needed:**

1. **Add new automation IDs:**
```javascript
export const AUTOMATION_IDS = {
  // ... existing IDs ...
  VPD_FAN_REDUCE: 'phenology_vpd_fan_reduce',
  VPD_FAN_RESTORE: 'phenology_vpd_fan_restore',
};
```

2. **Add entity constants:**
```javascript
// In dashboard/src/types/entities.js
export const ENTITIES = {
  // ... existing entities ...
  EXHAUST_FAN_ON_POWER: 'number.exhaust_fan_on_power',
  EXHAUST_FAN_CURRENT_POWER: 'sensor.exhaust_fan_current_power',
};
```

3. **Create fan power automation builders:**
```javascript
/**
 * Build automation: Reduce exhaust fan power when VPD is too high
 * Helps humidifier catch up by reducing air exchange
 */
export function buildVPDFanReduceAutomation(stage) {
  if (stage.id === 'harvest_dry') return null; // Skip for harvest stage

  const reducedPower = 2; // Low power (1-10 scale)
  
  return {
    id: AUTOMATION_IDS.VPD_FAN_REDUCE,
    alias: `Phenology: VPD High - Reduce Exhaust Fan (${stage.name})`,
    description: `Reduce exhaust fan power to ${reducedPower} when VPD > ${stage.vpd.max} kPa to help humidifier catch up. Auto-generated by GrowOp Dashboard.`,
    trigger: [
      {
        platform: 'numeric_state',
        entity_id: ENTITIES.VPD,
        above: stage.vpd.max, // Stage-specific (0.8 for seedling)
        for: { minutes: 5 }, // Prevent rapid cycling
      },
    ],
    condition: [
      {
        condition: 'state',
        entity_id: ENTITIES.LIGHT,
        state: 'on', // Only during day period (active transpiration)
      },
      {
        condition: 'state',
        entity_id: ENTITIES.EXHAUST_FAN_MODE,
        state: 'On', // Only if fan is currently on
      },
      {
        condition: 'numeric_state',
        entity_id: ENTITIES.EXHAUST_FAN_CURRENT_POWER,
        above: reducedPower, // Only reduce if currently higher
      },
    ],
    action: [
      {
        service: 'number.set_value',
        target: { entity_id: ENTITIES.EXHAUST_FAN_ON_POWER },
        data: { value: reducedPower },
      },
    ],
    mode: 'single',
  };
}

/**
 * Build automation: Restore exhaust fan power when VPD is optimal
 */
export function buildVPDFanRestoreAutomation(stage) {
  if (stage.id === 'harvest_dry') return null;

  const normalPower = 5; // Normal power level
  
  return {
    id: AUTOMATION_IDS.VPD_FAN_RESTORE,
    alias: `Phenology: VPD OK - Restore Exhaust Fan (${stage.name})`,
    description: `Restore exhaust fan power to ${normalPower} when VPD < ${stage.vpd.optimal} kPa. Auto-generated by GrowOp Dashboard.`,
    trigger: [
      {
        platform: 'numeric_state',
        entity_id: ENTITIES.VPD,
        below: stage.vpd.optimal, // Stage-specific (0.6 for seedling)
        for: { minutes: 10 }, // Longer delay to ensure stability
      },
    ],
    condition: [
      {
        condition: 'numeric_state',
        entity_id: ENTITIES.EXHAUST_FAN_CURRENT_POWER,
        below: normalPower, // Only restore if currently lower
      },
    ],
    action: [
      {
        service: 'number.set_value',
        target: { entity_id: ENTITIES.EXHAUST_FAN_ON_POWER },
        data: { value: normalPower },
      },
    ],
    mode: 'single',
  };
}
```

4. **Add to buildAllAutomations:**
```javascript
export function buildAllAutomations(stage) {
  const automations = [
    buildLightOnAutomation(stage),
    buildLightOffAutomation(stage),
    buildDayTempAutomation(stage),
    buildNightTempAutomation(stage),
    buildVPDHumidifierOnAutomation(stage),
    buildVPDHumidifierOffAutomation(stage),
    buildVPDFanReduceAutomation(stage),    // NEW
    buildVPDFanRestoreAutomation(stage),   // NEW
  ];

  return automations.filter(Boolean);
}
```

---

## How the Coordinated System Works

### Scenario 1: VPD Too High (Current Situation)

**Current State:**
- VPD: 2.09 kPa (target: 0.4-0.8)
- Humidity: 46% (target: 65-75%)
- Exhaust fan: Power 5
- Humidifier: Running but can't keep up

**Automation Sequence:**
1. **VPD > 0.8 kPa for 5 minutes** â†’ Triggers:
   - `phenology_vpd_humidifier_on` â†’ Turns ON humidifier
   - `phenology_vpd_fan_reduce` â†’ Reduces exhaust fan to power 2

2. **Result:**
   - Humidifier adds moisture
   - Exhaust fan removes less moisture (power 2 vs 5)
   - Net effect: Humidity increases, VPD decreases

3. **When VPD < 0.6 kPa:**
   - `phenology_vpd_humidifier_off` â†’ Turns OFF humidifier
   - `phenology_vpd_fan_restore` â†’ Restores exhaust fan to power 5
   - System returns to normal operation

### Scenario 2: VPD Too Low (Over-Humidification)

**State:**
- VPD: 0.3 kPa (below target minimum)
- Humidity: 85% (above target)

**Automation Sequence:**
1. **VPD < 0.4 kPa for 5 minutes** â†’ Triggers:
   - `phenology_vpd_humidifier_off` â†’ Turns OFF humidifier (if on)
   - Exhaust fan stays at power 5 (or increases if needed)

2. **Result:**
   - Humidifier stops adding moisture
   - Exhaust fan removes excess moisture
   - Net effect: Humidity decreases, VPD increases

### Scenario 3: VPD Optimal

**State:**
- VPD: 0.5-0.7 kPa (within target range)
- Humidity: 65-75%

**System State:**
- Humidifier: OFF (unless VPD drops below 0.4)
- Exhaust fan: Power 5 (normal)
- Heater: Maintaining target temp
- **All systems balanced** âœ…

---

## Advanced: Configurable Fan Power Levels

### Option 1: Hardcoded (Simple, Recommended for Now)

**Current Implementation:**
- Reduced power: 2 (fixed)
- Normal power: 5 (fixed)

**Pros:**
- Simple, works immediately
- No UI changes needed
- Easy to understand

**Cons:**
- Can't adjust per stage
- Can't fine-tune for different environments

### Option 2: Stage-Specific (Future Enhancement)

**Add to stage object:**
```javascript
{
  id: 'seedling',
  name: 'Seedling',
  // ... existing fields ...
  fanControl: {
    normalPower: 5,    // Normal exhaust fan power
    reducedPower: 2,   // Reduced power when VPD high
  },
}
```

**Update ScheduleEditor:**
- Add inputs for `fanNormalPower` and `fanReducedPower`
- Save to stage object
- Use in automation builders: `stage.fanControl.reducedPower`

**Pros:**
- Flexible per growth stage
- Can optimize for different VPD targets
- User-configurable

**Cons:**
- More complex UI
- More parameters to manage
- May be overkill for current needs

**Recommendation:** Start with hardcoded (Option 1), add configurable later if needed.

---

## Integration with Existing System

### Current Phenology Automations (6 total)
1. âœ… Light ON (time-based)
2. âœ… Light OFF (time-based)
3. âœ… Day Temperature (time-based)
4. âœ… Night Temperature (time-based)
5. âœ… VPD High - Humidifier ON (VPD-based)
6. âœ… VPD OK - Humidifier OFF (VPD-based)

### New Automations (2 total)
7. ðŸ†• VPD High - Reduce Exhaust Fan (VPD-based)
8. ðŸ†• VPD OK - Restore Exhaust Fan (VPD-based)

### Total: 8 Automations per Growth Stage

**Deployment:**
- All 8 automations deploy together when you:
  - Edit stage parameters and click "Save & Deploy"
  - Change growth stage in StageSelector
- Automations run 24/7 on Home Assistant (Raspberry Pi)
- Dashboard is only needed for configuration changes

---

## Testing & Validation

### Test Sequence

1. **Initial State Check:**
   - VPD: 2.09 kPa (too high)
   - Exhaust fan power: 5
   - Humidifier: Should be ON

2. **Trigger High VPD Automation:**
   - Wait 5 minutes (automation delay)
   - Verify: Exhaust fan power drops to 2
   - Verify: Humidifier remains ON
   - Monitor: VPD should start decreasing

3. **Wait for VPD to Drop:**
   - Monitor VPD sensor
   - When VPD < 0.6 kPa for 10 minutes:
     - Verify: Exhaust fan power restores to 5
     - Verify: Humidifier turns OFF
     - System should stabilize in target range

4. **Stability Test:**
   - Monitor for 24 hours
   - VPD should stay within 0.4-0.8 kPa range
   - Fan should cycle between 2 and 5 as needed
   - No rapid cycling (fan changing every few minutes)

### Expected Behavior

**Normal Operation:**
- VPD fluctuates between 0.4-0.8 kPa
- Fan power: 5 (normal)
- Humidifier: OFF (unless VPD spikes)

**High VPD Event:**
- VPD spikes above 0.8 kPa
- Fan power: 2 (reduced)
- Humidifier: ON
- VPD decreases over 30-60 minutes
- System returns to normal

**Low VPD Event:**
- VPD drops below 0.4 kPa
- Fan power: 5 (normal or higher)
- Humidifier: OFF
- VPD increases over 30-60 minutes
- System returns to normal

---

## Future Enhancements

### 1. Proportional Fan Control
Instead of binary (2 or 5), use proportional control:
- VPD 0.8-1.0 kPa â†’ Fan power 4
- VPD 1.0-1.2 kPa â†’ Fan power 3
- VPD > 1.2 kPa â†’ Fan power 2

### 2. Temperature-Aware Fan Control
Adjust fan power based on temperature AND VPD:
- High temp + High VPD â†’ Reduce fan more aggressively
- Low temp + High VPD â†’ Moderate fan reduction

### 3. Predictive Control
Use historical data to predict VPD trends:
- If VPD is rising rapidly â†’ Reduce fan preemptively
- If VPD is stable â†’ Maintain current settings

### 4. Multi-Device Coordination
Coordinate all three devices (fan, humidifier, heater):
- High VPD + High Temp â†’ Reduce fan, increase humidifier, maintain heater
- Low VPD + Low Temp â†’ Increase fan, reduce humidifier, increase heater

---

## Implementation Checklist

### Phase 1: Core Implementation
- [ ] Add `EXHAUST_FAN_ON_POWER` and `EXHAUST_FAN_CURRENT_POWER` to `entities.js`
- [ ] Add `VPD_FAN_REDUCE` and `VPD_FAN_RESTORE` to `AUTOMATION_IDS`
- [ ] Create `buildVPDFanReduceAutomation()` function
- [ ] Create `buildVPDFanRestoreAutomation()` function
- [ ] Add both to `buildAllAutomations()` array
- [ ] Test deployment with current seedling stage

### Phase 2: Testing & Validation
- [ ] Deploy automations to Home Assistant
- [ ] Verify automations appear in HA (8 total for seedling)
- [ ] Monitor VPD for 24 hours
- [ ] Verify fan power changes when VPD exceeds threshold
- [ ] Verify fan power restores when VPD returns to target
- [ ] Check for rapid cycling (should not change every few minutes)

### Phase 3: Documentation
- [ ] Update `docs/AUTOMATIONS.md` with new automations
- [ ] Update `docs/MANIFEST.md` with fan power control strategy
- [ ] Update `docs/CHANGELOG.md` with implementation date

### Phase 4: Optional Enhancements
- [ ] Add configurable fan power levels to ScheduleEditor (if needed)
- [ ] Add fan power monitoring to dashboard UI
- [ ] Create visualization showing fan power vs VPD over time

---

## Key Considerations

### Why This Approach Works

1. **Runs on Home Assistant (Raspberry Pi):**
   - Automations execute 24/7, even if dashboard is closed
   - No dependency on browser or network connection
   - Reliable, local execution

2. **Stage-Aware:**
   - Uses stage-specific VPD targets (0.4-0.8 for seedling)
   - Automatically adjusts when you change growth stages
   - Respects custom stage parameters

3. **Prevents Rapid Cycling:**
   - 5-minute delay before reducing fan (prevents false triggers)
   - 10-minute delay before restoring fan (ensures stability)
   - Conditions check current state before acting

4. **Works with Existing System:**
   - Integrates with existing VPD humidifier automations
   - Doesn't conflict with light/temperature schedules
   - Complements heater control

### Potential Issues & Solutions

**Issue:** Fan power changes too frequently
- **Solution:** Increase delay times (5 min â†’ 10 min, 10 min â†’ 15 min)

**Issue:** VPD still too high after fan reduction
- **Solution:** Reduce fan power further (2 â†’ 1) or increase humidifier capacity

**Issue:** Fan power doesn't change
- **Solution:** Verify `number.exhaust_fan_on_power` entity is settable via `number.set_value` service

**Issue:** System oscillates (VPD goes up and down repeatedly)
- **Solution:** Add hysteresis (different thresholds for reduce vs restore)

---

## Expected Outcomes

### Short Term (24-48 hours)
- VPD should decrease from 2.09 kPa toward target range (0.4-0.8 kPa)
- Humidity should increase from 46% toward target range (65-75%)
- Exhaust fan power should cycle between 2 and 5 as needed
- System should stabilize in target range

### Long Term (1-2 weeks)
- VPD consistently within 0.4-0.8 kPa range
- Humidity consistently within 65-75% range
- Minimal automation cycling (system finds balance)
- Plants show improved growth (proper transpiration)

---

## Next Steps

1. **Implement the code changes** in `automation-manager.js`
2. **Deploy to current stage** (seedling) via Schedule Editor
3. **Monitor for 24 hours** and verify VPD/humidity trends
4. **Adjust if needed** (fan power levels, delay times)
5. **Document results** in this file or CHANGELOG.md

---

**Status:** Ready for Implementation  
**Priority:** ðŸ”´ High (Critical for seedling health)  
**Estimated Impact:** Should reduce VPD from 2.09 kPa to <0.8 kPa within 24-48 hours
